generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

/// This table contains check constraints and requires additional setup for migrations. Visit https://pris.ly/d/check-constraints for more info.
model payments {
  id                                         String         @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  product_id                                 String         @db.Uuid
  creator_id                                 String         @db.Uuid
  method                                     payment_method
  status                                     payment_status @default(PENDING)

  // Existing (fiat/wallet/stripe)
  amount_cents                               Int
  currency                                   String         @default("PEN")
  payer_name                                 String?
  payer_email                                String?
  stripe_checkout_session_id                 String?
  stripe_payment_intent_id                   String?
  stripe_event_id                            String?
  wallet_operation_code                      String?
  wallet_report_note                         String?
  wallet_evidence_url                        String?
  reported_at                                DateTime?      @db.Timestamptz(6)
  confirmed_at                               DateTime?      @db.Timestamptz(6)
  confirmed_by_user_id                       String?        @db.Uuid

  // --- BTC (opcionales, no rompen Stripe/Yape/Plin) ---
  btc_network                                btc_network?
  btc_address                                String?
  btc_amount_sats                            BigInt?
  btc_txid                                   String?
  btc_confirmations                          Int            @default(0)
  btc_required_confirmations                 Int            @default(1)
  btc_expires_at                             DateTime?      @db.Timestamptz(6)
  btc_detected_at                            DateTime?      @db.Timestamptz(6)

  // --- BTC fiat-first (rate lock audit) ---
  btc_fx_rate                                Decimal?       @db.Decimal(18, 8)
  btc_rate_locked_at                         DateTime?      @db.Timestamptz(6)
  btc_rate_provider                          String?

  created_at                                 DateTime       @default(now()) @db.Timestamptz(6)
  updated_at                                 DateTime       @default(now()) @db.Timestamptz(6)

  users_payments_confirmed_by_user_idTousers users?         @relation("payments_confirmed_by_user_idTousers", fields: [confirmed_by_user_id], references: [id], onUpdate: NoAction)
  users_payments_creator_idTousers           users          @relation("payments_creator_idTousers", fields: [creator_id], references: [id], onDelete: Cascade, onUpdate: NoAction)
  products                                   products       @relation(fields: [product_id], references: [id], onUpdate: NoAction)

  payment_link_id                           String?         @db.Uuid
  payment_links                             payment_links?  @relation(fields: [payment_link_id], references: [id], onDelete: SetNull, onUpdate: NoAction)

  @@index([payment_link_id], map: "idx_payments_payment_link_id")
  @@index([creator_id, created_at(sort: Desc)], map: "idx_payments_creator_created_at")
  @@index([method], map: "idx_payments_method")
  @@index([product_id, created_at(sort: Desc)], map: "idx_payments_product_created_at")
  @@index([status], map: "idx_payments_status")

  // BTC indexes
  @@index([btc_address], map: "idx_payments_btc_address")
  @@index([btc_txid], map: "idx_payments_btc_txid")
  @@index([btc_expires_at], map: "idx_payments_btc_expires_at")
  @@index([status, btc_expires_at], map: "idx_payments_status_btc_expires_at")
  @@index([btc_rate_locked_at], map: "idx_payments_btc_rate_locked_at")


  // Si luego quieres endurecer para evitar reutilizar address en el mismo network:
  // @@unique([btc_network, btc_address], map: "uq_payments_btc_network_address")
  
}

/// This table contains check constraints and requires additional setup for migrations. Visit https://pris.ly/d/check-constraints for more info.
model products {
  id           String     @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  creator_id   String     @db.Uuid
  title        String
  message      String
  metadata_json Json?
  amount_cents Int
  currency     String     @default("PEN")
  active       Boolean    @default(true)
  yape_phone   String?
  plin_phone   String?
  yape_qr_url  String?
  plin_qr_url  String?
  created_at   DateTime   @default(now()) @db.Timestamptz(6)
  updated_at   DateTime   @default(now()) @db.Timestamptz(6)
  payments     payments[]
  users        users      @relation(fields: [creator_id], references: [id], onDelete: Cascade, onUpdate: NoAction)
  payment_links payment_links[]


  @@index([creator_id, active], map: "idx_products_creator_active")
  @@index([creator_id], map: "idx_products_creator_id")
}

model users {
  id                                            String     @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  email                                         String     @unique
  handle                                        String     @unique
  display_name                                  String?
  created_at                                    DateTime   @default(now()) @db.Timestamptz(6)
  updated_at                                    DateTime   @default(now()) @db.Timestamptz(6)
  payments_payments_confirmed_by_user_idTousers payments[] @relation("payments_confirmed_by_user_idTousers")
  payments_payments_creator_idTousers           payments[] @relation("payments_creator_idTousers")
  products                                      products[]
  sessions                                      sessions[]
  payment_links payment_links[]

}

model login_codes {
  id          String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  email       String
  code_hash   String
  expires_at  DateTime  @db.Timestamptz(6)
  consumed_at DateTime? @db.Timestamptz(6)
  created_at  DateTime  @default(now()) @db.Timestamptz(6)

  @@index([email, created_at(sort: Desc)], map: "idx_login_codes_email_created_at")
  @@index([email, expires_at], map: "idx_login_codes_email_expires_at")
}

model sessions {
  id                 String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  user_id            String   @db.Uuid
  session_token_hash String
  expires_at         DateTime @db.Timestamptz(6)
  created_at         DateTime @default(now()) @db.Timestamptz(6)

  users users @relation(fields: [user_id], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@index([user_id, expires_at], map: "idx_sessions_user_expires_at")
  @@index([session_token_hash], map: "idx_sessions_token_hash")
}

model payment_links {
  id          String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  creator_id  String   @db.Uuid
  product_id  String   @db.Uuid

  token       String   @unique
  active      Boolean  @default(true)

  created_at  DateTime @default(now()) @db.Timestamptz(6)
  updated_at  DateTime @default(now()) @db.Timestamptz(6)

  // relations
  products    products @relation(fields: [product_id], references: [id], onDelete: Cascade, onUpdate: NoAction)
  users       users    @relation(fields: [creator_id], references: [id], onDelete: Cascade, onUpdate: NoAction)
  payments    payments[]

  @@index([creator_id, active], map: "idx_payment_links_creator_active")
  @@index([product_id], map: "idx_payment_links_product_id")
  @@index([creator_id], map: "idx_payment_links_creator_id")
}


enum payment_method {
  CARD
  YAPE
  PLIN
  BTC_ONCHAIN
}

enum payment_status {
  PENDING
  AWAITING_PAYMENT
  SEEN_IN_MEMPOOL
  CONFIRMING
  CONFIRMED
  EXPIRED
  FAILED
}

enum btc_network {
  MAINNET
  TESTNET
  SIGNET
  REGTEST
}
